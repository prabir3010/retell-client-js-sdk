import{EventEmitter as t}from"eventemitter3";import{Room as e,Track as o,RoomEvent as a,RemoteAudioTrack as i,createAudioAnalyser as n}from"livekit-client";const r=new TextDecoder;class s extends t{constructor(){super(),this.room=void 0,this.connected=!1,this.isAgentTalking=!1,this.analyzerComponent=void 0,this.captureAudioFrame=void 0}async startCall(t){try{this.room=new e({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:t.captureDeviceId,sampleRate:t.sampleRate},audioOutput:{deviceId:t.playbackDeviceId}}),this.handleRoomEvents(),this.handleAudioEvents(t),this.handleDataEvents(),await this.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",t.accessToken),console.log("connected to room",this.room.name),t.simulationMode||this.room.localParticipant.setMicrophoneEnabled(!0),this.connected=!0,this.emit("call_started")}catch(t){this.emit("error","Error starting call"),console.error("Error starting call",t),this.stopCall()}}async startAudioPlayback(){await this.room.startAudio()}stopCall(){var t;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(t=this.room)||t.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame))}mute(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)}unmute(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)}async sendAudioBuffer(t){var e=this;if(!this.connected)throw new Error("Cannot send audio buffer: not connected to call");try{const a=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}),i=a.createBufferSource();i.buffer=t;const n=a.createMediaStreamDestination();i.connect(n);const r=n.stream.getAudioTracks()[0];if(!r)throw new Error("Failed to create audio track from buffer");return await this.room.localParticipant.publishTrack(r,{name:"simulated_audio",source:o.Source.Microphone}),console.log("Publishing audio buffer to call"),i.start(0),new Promise((o,n)=>{i.onended=async function(){try{console.log("Audio buffer playback completed"),e.room.localParticipant.audioTrackPublications.get("simulated_audio")&&await e.room.localParticipant.unpublishTrack(r),r.stop(),await a.close(),o()}catch(t){console.error("Error cleaning up audio buffer",t),n(t)}},setTimeout(async function(){console.warn("Audio buffer playback timeout");try{r.stop(),await a.close()}catch(t){console.error("Error in timeout cleanup",t)}n(new Error("Audio buffer playback timeout"))},1e3*(t.duration+5))})}catch(t){throw console.error("Error sending audio buffer",t),t}}captureAudioSamples(){if(!this.connected||!this.analyzerComponent)return;let t=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(()=>this.captureAudioSamples())}handleRoomEvents(){this.room.on(a.ParticipantDisconnected,t=>{"server"===(null==t?void 0:t.identity)&&setTimeout(()=>{this.stopCall()},500)}),this.room.on(a.Disconnected,()=>{this.stopCall()})}handleAudioEvents(t){this.room.on(a.TrackSubscribed,(e,a,r)=>{e.kind===o.Kind.Audio&&e instanceof i&&("agent_audio"===a.trackName&&(this.emit("call_ready"),t.emitRawAudioSamples&&(this.analyzerComponent=n(e),this.captureAudioFrame=window.requestAnimationFrame(()=>this.captureAudioSamples()))),e.attach())})}handleDataEvents(){this.room.on(a.DataReceived,(t,e,o,a)=>{try{if("server"!==(null==e?void 0:e.identity))return;let o=r.decode(t),a=JSON.parse(o);"update"===a.event_type?this.emit("update",a):"metadata"===a.event_type?this.emit("metadata",a):"agent_start_talking"===a.event_type?(this.isAgentTalking=!0,this.emit("agent_start_talking")):"agent_stop_talking"===a.event_type?(this.isAgentTalking=!1,this.emit("agent_stop_talking")):"node_transition"===a.event_type&&this.emit("node_transition",a)}catch(t){console.error("Error decoding data received",t)}})}}export{s as RetellWebClient};
