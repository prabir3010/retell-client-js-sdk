import{EventEmitter as t}from"eventemitter3";import{Room as e,Track as o,RoomEvent as n,RemoteAudioTrack as r,createAudioAnalyser as i}from"livekit-client";function a(t,e){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},a(t,e)}function c(t,e){try{var o=t()}catch(t){return e(t)}return o&&o.then?o.then(void 0,e):o}var u=new TextDecoder,s=/*#__PURE__*/function(t){var s,l;function d(){var e;return(e=t.call(this)||this).room=void 0,e.connected=!1,e.isAgentTalking=!1,e.analyzerComponent=void 0,e.captureAudioFrame=void 0,e.audioContext=void 0,e}l=t,(s=d).prototype=Object.create(l.prototype),s.prototype.constructor=s,a(s,l);var m=d.prototype;return m.startCall=function(t){try{var o=this,n=c(function(){return console.log("startCallConfig v1"),o.room=new e({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:t.captureDeviceId,sampleRate:t.sampleRate},audioOutput:{deviceId:t.playbackDeviceId}}),o.handleRoomEvents(),o.handleAudioEvents(t),o.handleDataEvents(),Promise.resolve(o.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",t.accessToken)).then(function(){console.log("connected to room",o.room.name),t.simulationMode?o.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}):o.room.localParticipant.setMicrophoneEnabled(!0),o.connected=!0,o.emit("call_started")})},function(t){o.emit("error","Error starting call"),console.error("Error starting call",t),o.stopCall()});return Promise.resolve(n&&n.then?n.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},m.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(t){return Promise.reject(t)}},m.stopCall=function(){var t;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(t=this.room)||t.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame),this.audioContext&&"closed"!==this.audioContext.state&&(this.audioContext.close(),delete this.audioContext))},m.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},m.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},m.sendAudioBuffer=function(t){try{var e=this;if(!e.connected)throw new Error("Cannot send audio buffer: not connected to call");if(!e.audioContext)throw new Error("AudioContext not initialized. Make sure to set simulationMode: true in startCall()");return Promise.resolve(c(function(){function n(){var n=e.audioContext.createBufferSource();n.buffer=t;var r=e.audioContext.createMediaStreamDestination();n.connect(r);var i=r.stream.getAudioTracks()[0];if(!i)throw new Error("Failed to create audio track from buffer");return Promise.resolve(e.room.localParticipant.publishTrack(i,{name:"simulated_audio",source:o.Source.Microphone})).then(function(){return console.log("Publishing audio buffer to call"),n.start(0),new Promise(function(o,a){var u=null,s=!1,l=function(t){void 0===t&&(t=!1);try{if(s)return Promise.resolve();s=!0,null!==u&&(clearTimeout(u),u=null);var l=c(function(){function c(){i.stop(),t?a(new Error("Audio buffer playback timeout")):(console.log("Audio buffer playback completed"),o())}n.disconnect(),r.disconnect();var u=e.room.localParticipant.audioTrackPublications.get("simulated_audio"),s=function(){if(u)return Promise.resolve(e.room.localParticipant.unpublishTrack(i)).then(function(){})}();return s&&s.then?s.then(c):c()},function(t){console.error("Error cleaning up audio buffer",t),a(t)});return Promise.resolve(l&&l.then?l.then(function(){}):void 0)}catch(t){return Promise.reject(t)}};n.onended=function(){return l(!1)},u=window.setTimeout(function(){console.warn("Audio buffer playback timeout"),l(!0)},1e3*(t.duration+5))})})}var r=function(){if("suspended"===e.audioContext.state)return Promise.resolve(e.audioContext.resume()).then(function(){})}();return r&&r.then?r.then(n):n()},function(t){throw console.error("Error sending audio buffer",t),t}))}catch(t){return Promise.reject(t)}},m.captureAudioSamples=function(){var t=this;if(this.connected&&this.analyzerComponent){var e=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(e),this.emit("audio",e),this.captureAudioFrame=window.requestAnimationFrame(function(){return t.captureAudioSamples()})}},m.handleRoomEvents=function(){var t=this;this.room.on(n.ParticipantDisconnected,function(e){"server"===(null==e?void 0:e.identity)&&setTimeout(function(){t.stopCall()},500)}),this.room.on(n.Disconnected,function(){t.stopCall()})},m.handleAudioEvents=function(t){var e=this;this.room.on(n.TrackSubscribed,function(n,a,c){n.kind===o.Kind.Audio&&n instanceof r&&("agent_audio"===a.trackName&&(e.emit("call_ready"),t.emitRawAudioSamples&&(e.analyzerComponent=i(n),e.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()}))),n.attach())})},m.handleDataEvents=function(){var t=this;this.room.on(n.DataReceived,function(e,o,n,r){try{if("server"!==(null==o?void 0:o.identity))return;var i=u.decode(e),a=JSON.parse(i);"update"===a.event_type?t.emit("update",a):"metadata"===a.event_type?t.emit("metadata",a):"agent_start_talking"===a.event_type?(t.isAgentTalking=!0,t.emit("agent_start_talking")):"agent_stop_talking"===a.event_type?(t.isAgentTalking=!1,t.emit("agent_stop_talking")):"node_transition"===a.event_type&&t.emit("node_transition",a)}catch(t){console.error("Error decoding data received",t)}})},d}(t);export{s as RetellWebClient};
