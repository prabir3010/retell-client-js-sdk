import{EventEmitter as e}from"eventemitter3";import{Room as t,Track as n,RoomEvent as o,RemoteAudioTrack as r,createAudioAnalyser as i}from"livekit-client";function a(e,t){return a=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},a(e,t)}function c(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var u=new TextDecoder,s=/*#__PURE__*/function(e){var s,l;function d(){var t;return(t=e.call(this)||this).room=void 0,t.connected=!1,t.isAgentTalking=!1,t.analyzerComponent=void 0,t.captureAudioFrame=void 0,t}l=e,(s=d).prototype=Object.create(l.prototype),s.prototype.constructor=s,a(s,l);var m=d.prototype;return m.startCall=function(e){try{var n=this,o=c(function(){return n.room=new t({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:e.captureDeviceId,sampleRate:e.sampleRate},audioOutput:{deviceId:e.playbackDeviceId}}),n.handleRoomEvents(),n.handleAudioEvents(e),n.handleDataEvents(),Promise.resolve(n.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",e.accessToken)).then(function(){console.log("connected to room",n.room.name),e.simulationMode||n.room.localParticipant.setMicrophoneEnabled(!0),n.connected=!0,n.emit("call_started")})},function(e){n.emit("error","Error starting call"),console.error("Error starting call",e),n.stopCall()});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},m.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(e){return Promise.reject(e)}},m.stopCall=function(){var e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(e=this.room)||e.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame))},m.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},m.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},m.sendAudioBuffer=function(e){try{var t=this;if(!t.connected)throw new Error("Cannot send audio buffer: not connected to call");return Promise.resolve(c(function(){var o=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}),r=o.createBufferSource();r.buffer=e;var i=o.createMediaStreamDestination();r.connect(i);var a=i.stream.getAudioTracks()[0];if(!a)throw new Error("Failed to create audio track from buffer");return Promise.resolve(t.room.localParticipant.publishTrack(a,{name:"simulated_audio",source:n.Source.Microphone})).then(function(){return console.log("Publishing audio buffer to call"),r.start(0),new Promise(function(n,i){r.onended=function(){try{var e=c(function(){function e(){return a.stop(),Promise.resolve(o.close()).then(function(){n()})}console.log("Audio buffer playback completed");var r=t.room.localParticipant.audioTrackPublications.get("simulated_audio"),i=function(){if(r)return Promise.resolve(t.room.localParticipant.unpublishTrack(a)).then(function(){})}();return i&&i.then?i.then(e):e()},function(e){console.error("Error cleaning up audio buffer",e),i(e)});return Promise.resolve(e&&e.then?e.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},setTimeout(function(){try{var e=function(){i(new Error("Audio buffer playback timeout"))};console.warn("Audio buffer playback timeout");var t=c(function(){return a.stop(),Promise.resolve(o.close()).then(function(){})},function(e){console.error("Error in timeout cleanup",e)});return Promise.resolve(t&&t.then?t.then(e):e())}catch(e){return Promise.reject(e)}},1e3*(e.duration+5))})})},function(e){throw console.error("Error sending audio buffer",e),e}))}catch(e){return Promise.reject(e)}},m.captureAudioSamples=function(){var e=this;if(this.connected&&this.analyzerComponent){var t=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()})}},m.handleRoomEvents=function(){var e=this;this.room.on(o.ParticipantDisconnected,function(t){"server"===(null==t?void 0:t.identity)&&setTimeout(function(){e.stopCall()},500)}),this.room.on(o.Disconnected,function(){e.stopCall()})},m.handleAudioEvents=function(e){var t=this;this.room.on(o.TrackSubscribed,function(o,a,c){o.kind===n.Kind.Audio&&o instanceof r&&("agent_audio"===a.trackName&&(t.emit("call_ready"),e.emitRawAudioSamples&&(t.analyzerComponent=i(o),t.captureAudioFrame=window.requestAnimationFrame(function(){return t.captureAudioSamples()}))),o.attach())})},m.handleDataEvents=function(){var e=this;this.room.on(o.DataReceived,function(t,n,o,r){try{if("server"!==(null==n?void 0:n.identity))return;var i=u.decode(t),a=JSON.parse(i);"update"===a.event_type?e.emit("update",a):"metadata"===a.event_type?e.emit("metadata",a):"agent_start_talking"===a.event_type?(e.isAgentTalking=!0,e.emit("agent_start_talking")):"agent_stop_talking"===a.event_type?(e.isAgentTalking=!1,e.emit("agent_stop_talking")):"node_transition"===a.event_type&&e.emit("node_transition",a)}catch(e){console.error("Error decoding data received",e)}})},d}(e);export{s as RetellWebClient};
