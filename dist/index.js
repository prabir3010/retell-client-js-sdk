var e=require("eventemitter3"),t=require("livekit-client");function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}function n(e,t){try{var o=e()}catch(e){return t(e)}return o&&o.then?o.then(void 0,t):o}var r=new TextDecoder;exports.RetellWebClient=/*#__PURE__*/function(e){var i,a;function c(){var t;return(t=e.call(this)||this).room=void 0,t.connected=!1,t.isAgentTalking=!1,t.analyzerComponent=void 0,t.captureAudioFrame=void 0,t.audioContext=void 0,t}a=e,(i=c).prototype=Object.create(a.prototype),i.prototype.constructor=i,o(i,a);var u=c.prototype;return u.startCall=function(e){try{var o=this,r=n(function(){return o.room=new t.Room({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:e.captureDeviceId,sampleRate:e.sampleRate},audioOutput:{deviceId:e.playbackDeviceId}}),o.handleRoomEvents(),o.handleAudioEvents(e),o.handleDataEvents(),Promise.resolve(o.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",e.accessToken)).then(function(){console.log("connected to room",o.room.name),e.simulationMode?o.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}):o.room.localParticipant.setMicrophoneEnabled(!0),o.connected=!0,o.emit("call_started")})},function(e){o.emit("error","Error starting call"),console.error("Error starting call",e),o.stopCall()});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},u.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(e){return Promise.reject(e)}},u.stopCall=function(){var e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(e=this.room)||e.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame),this.audioContext&&"closed"!==this.audioContext.state&&(this.audioContext.close(),delete this.audioContext))},u.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},u.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},u.sendAudioBuffer=function(e){try{var o=this;if(!o.connected)throw new Error("Cannot send audio buffer: not connected to call");if(!o.audioContext)throw new Error("AudioContext not initialized. Make sure to set simulationMode: true in startCall()");return Promise.resolve(n(function(){function r(){var r=o.audioContext.createBufferSource();r.buffer=e;var i=o.audioContext.createMediaStreamDestination();r.connect(i);var a=i.stream.getAudioTracks()[0];if(!a)throw new Error("Failed to create audio track from buffer");return Promise.resolve(o.room.localParticipant.publishTrack(a,{name:"simulated_audio",source:t.Track.Source.Microphone})).then(function(){return console.log("Publishing audio buffer to call"),r.start(0),new Promise(function(t,i){var c=null,u=!1,s=function(e){void 0===e&&(e=!1);try{if(u)return Promise.resolve();u=!0,null!==c&&(clearTimeout(c),c=null);var r=n(function(){function n(){a.stop(),e?i(new Error("Audio buffer playback timeout")):(console.log("Audio buffer playback completed"),t())}var r=o.room.localParticipant.audioTrackPublications.get("simulated_audio"),c=function(){if(r)return Promise.resolve(o.room.localParticipant.unpublishTrack(a)).then(function(){})}();return c&&c.then?c.then(n):n()},function(e){console.error("Error cleaning up audio buffer",e),i(e)});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}};r.onended=function(){return s(!1)},c=window.setTimeout(function(){console.warn("Audio buffer playback timeout"),s(!0)},1e3*(e.duration+5))})})}var i=function(){if("suspended"===o.audioContext.state)return Promise.resolve(o.audioContext.resume()).then(function(){})}();return i&&i.then?i.then(r):r()},function(e){throw console.error("Error sending audio buffer",e),e}))}catch(e){return Promise.reject(e)}},u.captureAudioSamples=function(){var e=this;if(this.connected&&this.analyzerComponent){var t=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()})}},u.handleRoomEvents=function(){var e=this;this.room.on(t.RoomEvent.ParticipantDisconnected,function(t){"server"===(null==t?void 0:t.identity)&&setTimeout(function(){e.stopCall()},500)}),this.room.on(t.RoomEvent.Disconnected,function(){e.stopCall()})},u.handleAudioEvents=function(e){var o=this;this.room.on(t.RoomEvent.TrackSubscribed,function(n,r,i){n.kind===t.Track.Kind.Audio&&n instanceof t.RemoteAudioTrack&&("agent_audio"===r.trackName&&(o.emit("call_ready"),e.emitRawAudioSamples&&(o.analyzerComponent=t.createAudioAnalyser(n),o.captureAudioFrame=window.requestAnimationFrame(function(){return o.captureAudioSamples()}))),n.attach())})},u.handleDataEvents=function(){var e=this;this.room.on(t.RoomEvent.DataReceived,function(t,o,n,i){try{if("server"!==(null==o?void 0:o.identity))return;var a=r.decode(t),c=JSON.parse(a);"update"===c.event_type?e.emit("update",c):"metadata"===c.event_type?e.emit("metadata",c):"agent_start_talking"===c.event_type?(e.isAgentTalking=!0,e.emit("agent_start_talking")):"agent_stop_talking"===c.event_type?(e.isAgentTalking=!1,e.emit("agent_stop_talking")):"node_transition"===c.event_type&&e.emit("node_transition",c)}catch(e){console.error("Error decoding data received",e)}})},c}(e.EventEmitter);
