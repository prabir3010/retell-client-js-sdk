!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("eventemitter3"),require("livekit-client")):"function"==typeof define&&define.amd?define(["exports","eventemitter3","livekit-client"],t):t((e||self).retellClientJsSdk={},e.eventemitter3,e.livekitClient)}(this,function(e,t,n){function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}function r(e,t){try{var n=e()}catch(e){return t(e)}return n&&n.then?n.then(void 0,t):n}var i=new TextDecoder;e.RetellWebClient=/*#__PURE__*/function(e){var t,a;function u(){var t;return(t=e.call(this)||this).room=void 0,t.connected=!1,t.isAgentTalking=!1,t.analyzerComponent=void 0,t.captureAudioFrame=void 0,t.audioContext=void 0,t.audioTrackCounter=0,t.currentAudioPublication=void 0,t}a=e,(t=u).prototype=Object.create(a.prototype),t.prototype.constructor=t,o(t,a);var c=u.prototype;return c.startCall=function(e){try{var t=this,o=r(function(){return console.log("startCallConfig v1"),t.room=new n.Room({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:e.captureDeviceId,sampleRate:e.sampleRate},audioOutput:{deviceId:e.playbackDeviceId}}),t.handleRoomEvents(),t.handleAudioEvents(e),t.handleDataEvents(),Promise.resolve(t.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",e.accessToken)).then(function(){console.log("connected to room",t.room.name),e.simulationMode?t.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}):t.room.localParticipant.setMicrophoneEnabled(!0),t.connected=!0,t.emit("call_started")})},function(e){t.emit("error","Error starting call"),console.error("Error starting call",e),t.stopCall()});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},c.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(e){return Promise.reject(e)}},c.stopCall=function(){var e;if(this.connected){if(this.connected=!1,this.emit("call_ended"),null==(e=this.room)||e.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame),this.currentAudioPublication){try{this.room.localParticipant.unpublishTrack(this.currentAudioPublication.track)}catch(e){console.warn("Error unpublishing track on stopCall",e)}delete this.currentAudioPublication}this.audioContext&&"closed"!==this.audioContext.state&&(this.audioContext.close(),delete this.audioContext),this.audioTrackCounter=0}},c.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},c.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},c.sendAudioChunk=function(e){try{var t=this;if(!t.connected)throw new Error("Cannot send audio chunk: not connected to call");if(!t.audioContext)throw new Error("AudioContext not initialized. Make sure to set simulationMode: true in startCall()");return Promise.resolve(r(function(){function o(){function o(){return u.start(0),Promise.resolve(new Promise(function(e){u.onended=function(){try{u.disconnect(),c.disconnect()}catch(e){}s.stop(),e()}})).then(function(){})}for(var r=new Float32Array(e.length),i=0;i<e.length;i++)r[i]=e[i]/32768;var a=t.audioContext.createBuffer(1,r.length,24e3);a.getChannelData(0).set(r);var u=t.audioContext.createBufferSource();u.buffer=a;var c=t.audioContext.createMediaStreamDestination();u.connect(c);var s=c.stream.getAudioTracks()[0];if(!s)throw new Error("Failed to create audio track from chunk");var l="simulated_audio_stream",d=function(){if(!t.currentAudioPublication)return Promise.resolve(t.room.localParticipant.publishTrack(s,{name:l,source:n.Track.Source.Microphone})).then(function(e){t.currentAudioPublication=e,console.log("ðŸ“¤ Published streaming track ("+l+")")})}();return d&&d.then?d.then(o):o()}var r=function(){if("suspended"===t.audioContext.state)return Promise.resolve(t.audioContext.resume()).then(function(){})}();return r&&r.then?r.then(o):o()},function(e){throw console.error("Error sending audio chunk",e),e}))}catch(e){return Promise.reject(e)}},c.sendAudioBuffer=function(e){try{var t=this;if(!t.connected)throw new Error("Cannot send audio buffer: not connected to call");if(!t.audioContext)throw new Error("AudioContext not initialized. Make sure to set simulationMode: true in startCall()");return Promise.resolve(r(function(){function o(){function o(){var o=t.audioContext.createBufferSource();o.buffer=e;var r=t.audioContext.createMediaStreamDestination();o.connect(r);var i=r.stream.getAudioTracks()[0];if(!i)throw new Error("Failed to create audio track from buffer");var a="simulated_audio_"+t.audioTrackCounter++;return Promise.resolve(t.room.localParticipant.publishTrack(i,{name:a,source:n.Track.Source.Microphone})).then(function(n){return t.currentAudioPublication=n,console.log("Publishing audio buffer to call ("+a+")"),Promise.resolve(new Promise(function(e){return setTimeout(e,400)})).then(function(){return o.start(0),new Promise(function(t,n){var a=null,u=!1,c=function(e){void 0===e&&(e=!1);try{if(u)return Promise.resolve();u=!0,null!==a&&(clearTimeout(a),a=null);try{o.disconnect(),r.disconnect(),i.stop(),e?n(new Error("Audio buffer playback timeout")):(console.log("Audio buffer playback completed"),t())}catch(e){console.error("Error cleaning up audio buffer",e),n(e)}return Promise.resolve()}catch(e){return Promise.reject(e)}};o.onended=function(){return c(!1)},a=window.setTimeout(function(){console.warn("Audio buffer playback timeout"),c(!0)},1e3*(e.duration+5))})})})}var r=function(){if("suspended"===t.audioContext.state)return Promise.resolve(t.audioContext.resume()).then(function(){})}();return r&&r.then?r.then(o):o()}var i=function(){if(t.currentAudioPublication){var e=function(){t.currentAudioPublication=void 0},n=r(function(){return Promise.resolve(t.room.localParticipant.unpublishTrack(t.currentAudioPublication.track)).then(function(){console.log("Unpublished previous audio track")})},function(e){console.warn("Error unpublishing previous track",e)});return n&&n.then?n.then(e):e()}}();return i&&i.then?i.then(o):o()},function(e){throw console.error("Error sending audio buffer",e),e}))}catch(e){return Promise.reject(e)}},c.captureAudioSamples=function(){var e=this;if(this.connected&&this.analyzerComponent){var t=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()})}},c.handleRoomEvents=function(){var e=this;this.room.on(n.RoomEvent.ParticipantDisconnected,function(t){"server"===(null==t?void 0:t.identity)&&setTimeout(function(){e.stopCall()},500)}),this.room.on(n.RoomEvent.Disconnected,function(){e.stopCall()})},c.handleAudioEvents=function(e){var t=this;this.room.on(n.RoomEvent.TrackSubscribed,function(o,r,i){o.kind===n.Track.Kind.Audio&&o instanceof n.RemoteAudioTrack&&("agent_audio"===r.trackName&&(t.emit("call_ready"),e.emitRawAudioSamples&&(t.analyzerComponent=n.createAudioAnalyser(o),t.captureAudioFrame=window.requestAnimationFrame(function(){return t.captureAudioSamples()}))),o.attach())})},c.handleDataEvents=function(){var e=this;this.room.on(n.RoomEvent.DataReceived,function(t,n,o,r){try{if("server"!==(null==n?void 0:n.identity))return;var a=i.decode(t),u=JSON.parse(a);"update"===u.event_type?e.emit("update",u):"metadata"===u.event_type?e.emit("metadata",u):"agent_start_talking"===u.event_type?(e.isAgentTalking=!0,e.emit("agent_start_talking")):"agent_stop_talking"===u.event_type?(e.isAgentTalking=!1,e.emit("agent_stop_talking")):"node_transition"===u.event_type&&e.emit("node_transition",u)}catch(e){console.error("Error decoding data received",e)}})},u}(t.EventEmitter)});
