!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("eventemitter3"),require("livekit-client")):"function"==typeof define&&define.amd?define(["exports","eventemitter3","livekit-client"],e):e((t||self).retellClientJsSdk={},t.eventemitter3,t.livekitClient)}(this,function(t,e,n){function o(t,e){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},o(t,e)}function i(t,e){try{var n=t()}catch(t){return e(t)}return n&&n.then?n.then(void 0,e):n}function r(t,e,n){if(!t.s){if(n instanceof u){if(!n.s)return void(n.o=r.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(r.bind(null,t,e),r.bind(null,t,2));t.s=e,t.v=n;var o=t.o;o&&o(t)}}var a=new TextDecoder;const u=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,n){const o=new t,i=this.s;if(i){const t=1&i?e:n;if(t){try{r(o,1,t(this.v))}catch(t){r(o,2,t)}return o}return this}return this.o=function(t){try{const i=t.v;1&t.s?r(o,1,e?e(i):i):n?r(o,1,n(i)):r(o,2,i)}catch(t){r(o,2,t)}},o},t}();function c(t){return t instanceof u&&1&t.s}t.RetellWebClient=/*#__PURE__*/function(t){var e,s;function l(){var e;return(e=t.call(this)||this).room=void 0,e.connected=!1,e.isAgentTalking=!1,e.analyzerComponent=void 0,e.captureAudioFrame=void 0,e.audioContext=void 0,e.audioTrackCounter=0,e.currentAudioPublication=void 0,e}s=t,(e=l).prototype=Object.create(s.prototype),e.prototype.constructor=e,o(e,s);var d=l.prototype;return d.startCall=function(t){try{var e=this,o=i(function(){return console.log("startCallConfig v1"),e.room=new n.Room({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:t.captureDeviceId,sampleRate:t.sampleRate},audioOutput:{deviceId:t.playbackDeviceId}}),e.handleRoomEvents(),e.handleAudioEvents(t),e.handleDataEvents(),Promise.resolve(e.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",t.accessToken)).then(function(){console.log("connected to room",e.room.name),t.simulationMode?e.audioContext=new(window.AudioContext||window.webkitAudioContext)({sampleRate:24e3}):e.room.localParticipant.setMicrophoneEnabled(!0),e.connected=!0,e.emit("call_started")})},function(t){e.emit("error","Error starting call"),console.error("Error starting call",t),e.stopCall()});return Promise.resolve(o&&o.then?o.then(function(){}):void 0)}catch(t){return Promise.reject(t)}},d.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(t){return Promise.reject(t)}},d.stopCall=function(){var t;if(this.connected){if(this.connected=!1,this.emit("call_ended"),null==(t=this.room)||t.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame),this.currentAudioPublication){try{this.room.localParticipant.unpublishTrack(this.currentAudioPublication.track)}catch(t){console.warn("Error unpublishing track on stopCall",t)}delete this.currentAudioPublication}this.audioContext&&"closed"!==this.audioContext.state&&(this.audioContext.close(),delete this.audioContext),this.audioTrackCounter=0}},d.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},d.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},d.sendAudioBuffer=function(t){try{var e=this;if(!e.connected)throw new Error("Cannot send audio buffer: not connected to call");if(!e.audioContext)throw new Error("AudioContext not initialized. Make sure to set simulationMode: true in startCall()");return Promise.resolve(i(function(){function o(){function o(){console.log("Starting progressive audio streaming ("+t.duration.toFixed(2)+"s)");var o=e.audioContext.createMediaStreamDestination(),i=o.stream.getAudioTracks()[0];if(!i)throw new Error("Failed to create audio track");var r="simulated_audio_"+e.audioTrackCounter++;return Promise.resolve(e.room.localParticipant.publishTrack(i,{name:r,source:n.Track.Source.Microphone})).then(function(n){return e.currentAudioPublication=n,console.log("Published progressive audio track ("+r+")"),Promise.resolve(new Promise(function(t){return setTimeout(t,200)})).then(function(){return Promise.resolve(e.sendAudioProgressively(t,o)).then(function(){o.disconnect(),i.stop(),console.log("Progressive audio streaming completed")})})})}var i=function(){if("suspended"===e.audioContext.state)return Promise.resolve(e.audioContext.resume()).then(function(){})}();return i&&i.then?i.then(o):o()}var r=function(){if(e.currentAudioPublication){var t=function(){e.currentAudioPublication=void 0},n=i(function(){return Promise.resolve(e.room.localParticipant.unpublishTrack(e.currentAudioPublication.track)).then(function(){console.log("Unpublished previous audio track")})},function(t){console.warn("Error unpublishing previous track",t)});return n&&n.then?n.then(t):t()}}();return r&&r.then?r.then(o):o()},function(t){throw console.error("Error sending audio buffer",t),t}))}catch(t){return Promise.reject(t)}},d.sendAudioProgressively=function(t,e){try{var n=function(){var t=(l%s||s)/i*1e3;return Promise.resolve(new Promise(function(e){return setTimeout(e,t+100)})).then(function(){})},o=this,i=t.sampleRate,a=t.getChannelData(0),s=Math.floor(20*i/1e3),l=a.length,d=Math.ceil(l/s);console.log("  Sending "+d+" chunks (20ms each)...");var h=0,f=o.audioContext.currentTime,m=0,v=function(t,e,n){for(var o;;){var i=t();if(c(i)&&(i=i.v),!i)return a;if(i.then){o=0;break}var a=n();if(a&&a.then){if(!c(a)){o=1;break}a=a.s}if(e){var s=e();if(s&&s.then&&!c(s)){o=2;break}}}var l=new u,d=r.bind(null,l,2);return(0===o?i.then(f):1===o?a.then(h):s.then(m)).then(void 0,d),l;function h(o){a=o;do{if(e&&(s=e())&&s.then&&!c(s))return void s.then(m).then(void 0,d);if(!(i=t())||c(i)&&!i.v)return void r(l,1,a);if(i.then)return void i.then(f).then(void 0,d);c(a=n())&&(a=a.v)}while(!a||!a.then);a.then(h).then(void 0,d)}function f(t){t?(a=n())&&a.then?a.then(h).then(void 0,d):h(a):r(l,1,a)}function m(){(i=t())?i.then?i.then(f).then(void 0,d):f(i):r(l,1,a)}}(function(){return m<d},function(){return m++},function(){for(var t=Math.min(s,l-h),n=o.audioContext.createBuffer(1,t,i),r=n.getChannelData(0),u=0;u<t;u++)r[u]=a[h+u];var c=o.audioContext.createBufferSource();return c.buffer=n,c.connect(e),c.start(f+20*m/1e3),h+=t,Promise.resolve(new Promise(function(t){return setTimeout(t,20)})).then(function(){})});return Promise.resolve(v&&v.then?v.then(n):n())}catch(t){return Promise.reject(t)}},d.captureAudioSamples=function(){var t=this;if(this.connected&&this.analyzerComponent){var e=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(e),this.emit("audio",e),this.captureAudioFrame=window.requestAnimationFrame(function(){return t.captureAudioSamples()})}},d.handleRoomEvents=function(){var t=this;this.room.on(n.RoomEvent.ParticipantDisconnected,function(e){"server"===(null==e?void 0:e.identity)&&setTimeout(function(){t.stopCall()},500)}),this.room.on(n.RoomEvent.Disconnected,function(){t.stopCall()})},d.handleAudioEvents=function(t){var e=this;this.room.on(n.RoomEvent.TrackSubscribed,function(o,i,r){o.kind===n.Track.Kind.Audio&&o instanceof n.RemoteAudioTrack&&("agent_audio"===i.trackName&&(e.emit("call_ready"),t.emitRawAudioSamples&&(e.analyzerComponent=n.createAudioAnalyser(o),e.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()}))),o.attach())})},d.handleDataEvents=function(){var t=this;this.room.on(n.RoomEvent.DataReceived,function(e,n,o,i){try{if("server"!==(null==n?void 0:n.identity))return;var r=a.decode(e),u=JSON.parse(r);"update"===u.event_type?t.emit("update",u):"metadata"===u.event_type?t.emit("metadata",u):"agent_start_talking"===u.event_type?(t.isAgentTalking=!0,t.emit("agent_start_talking")):"agent_stop_talking"===u.event_type?(t.isAgentTalking=!1,t.emit("agent_stop_talking")):"node_transition"===u.event_type&&t.emit("node_transition",u)}catch(t){console.error("Error decoding data received",t)}})},l}(e.EventEmitter)});
